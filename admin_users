<?php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

if (empty($_SESSION['logged_in']) || $_SESSION['logged_in'] !== true ||
    empty($_SESSION['account_type']) || $_SESSION['account_type'] !== 'admin') {
    $_SESSION['login_error'] = 'Admin access only.';
    header('Location: browse.php');
    exit;
}

require_once 'config.php';
$conn = get_database_connection();
include_once 'header.php';

$errors  = [];
$success = '';

/* -------------------------
   Update user role
--------------------------- */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['change_role'])) {

    $targetUserId = (int)($_POST['user_id'] ?? 0);
    $newRole      = $_POST['new_role'] ?? '';
    $validRoles   = ['buyer', 'seller', 'admin'];

    if ($targetUserId <= 0 || !in_array($newRole, $validRoles, true)) {
        $errors[] = 'Invalid user or role.';
    } else {
        // 不允许把自己从 admin 降级
        if ($targetUserId == $_SESSION['user_id'] && $newRole !== 'admin') {
            $errors[] = 'You cannot change your own role.';
        } else {
            $stmt = $conn->prepare("UPDATE users SET role = ? WHERE user_id = ?");
            if ($stmt) {
                $stmt->bind_param("si", $newRole, $targetUserId);
                if ($stmt->execute()) {
                    $success = 'Role updated successfully.';
                } else {
                    $errors[] = 'Database error updating role: ' . $stmt->error;
                }
                $stmt->close();
            } else {
                $errors[] = 'Database prepare() error: ' . $conn->error;
            }
        }
    }
}

/* -------------------------
   Ban / Unban user
--------------------------- */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['ban_action'])) {

    $targetUserId = (int)($_POST['user_id'] ?? 0);
    $newStatus    = $_POST['new_status'] ?? '';
    $validStatuses = ['active', 'banned'];

    if ($targetUserId <= 0 || !in_array($newStatus, $validStatuses, true)) {
        $errors[] = 'Invalid user or status.';
    } else {
        // 不允许管理员把自己拉黑
        if ($targetUserId == $_SESSION['user_id'] && $newStatus === 'banned') {
            $errors[] = 'You cannot ban your own account.';
        } else {
            $stmt = $conn->prepare("UPDATE users SET status = ? WHERE user_id = ?");
            if ($stmt) {
                $stmt->bind_param("si", $newStatus, $targetUserId);
                if ($stmt->execute()) {
                    $success = ($newStatus === 'banned')
                        ? 'User has been banned.'
                        : 'User has been unbanned.';
                } else {
                    $errors[] = 'Database error updating status: ' . $stmt->error;
                }
                $stmt->close();
            } else {
                $errors[] = 'Database prepare() error (status): ' . $conn->error;
            }
        }
    }
}

/* -------------------------
   Fetch all users
--------------------------- */
$users = [];
$result = $conn->query("
    SELECT user_id, username, email, role, status, created_at
      FROM users
     ORDER BY created_at DESC
");

if ($result) {
    $users = $result->fetch_all(MYSQLI_ASSOC);
    $result->close();
} else {
    $errors[] = 'Database error fetching users: ' . $conn->error;
}
?>

<div class="container my-5">
  <h2 class="mb-4">Admin: User Management</h2>

  <?php if (!empty($errors)): ?>
    <div class="alert alert-danger">
      <ul class="mb-0">
      <?php foreach ($errors as $e): ?>
        <li><?= htmlspecialchars($e) ?></li>
      <?php endforeach; ?>
      </ul>
    </div>
  <?php endif; ?>

  <?php if ($success): ?>
    <div class="alert alert-success"><?= htmlspecialchars($success) ?></div>
  <?php endif; ?>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>User ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Role</th>
        <th>Status</th>
        <th>Member since</th>
        <th>Change role</th>
        <th>Ban / Unban</th>
      </tr>
    </thead>
    <tbody>
    <?php foreach ($users as $u): ?>
      <tr>
        <td><?= (int)$u['user_id'] ?></td>
        <td><?= htmlspecialchars($u['username']) ?></td>
        <td><?= htmlspecialchars($u['email']) ?></td>
        <td><?= htmlspecialchars($u['role']) ?></td>

        <!-- 状态列 -->
        <td>
          <?php if ($u['status'] === 'banned'): ?>
            <span class="badge badge-danger">banned</span>
          <?php else: ?>
            <span class="badge badge-success">active</span>
          <?php endif; ?>
        </td>

        <td><?= htmlspecialchars($u['created_at']) ?></td>

        <!-- 修改角色 -->
        <td>
          <form method="post" action="admin_users.php" class="form-inline">
            <input type="hidden" name="user_id" value="<?= (int)$u['user_id'] ?>">

            <select name="new_role" class="form-control form-control-sm mr-2">
                <option value="buyer"  <?= $u['role']==='buyer'  ? 'selected' : '' ?>>buyer</option>
                <option value="seller" <?= $u['role']==='seller' ? 'selected' : '' ?>>seller</option>
                <option value="admin"  <?= $u['role']==='admin'  ? 'selected' : '' ?>>admin</option>
            </select>

            <button type="submit"
                    name="change_role"
                    class="btn btn-sm btn-primary">
                Update
            </button>
          </form>
        </td>

        <!-- Ban / Unban 按钮 -->
        <td>
          <form method="post" action="admin_users.php" class="form-inline">
            <input type="hidden" name="user_id" value="<?= (int)$u['user_id'] ?>">

            <?php if ($u['status'] === 'banned'): ?>
              <input type="hidden" name="new_status" value="active">
              <button type="submit"
                      name="ban_action"
                      class="btn btn-sm btn-success">
                Unban
              </button>
            <?php else: ?>
              <input type="hidden" name="new_status" value="banned">
              <button type="submit"
                      name="ban_action"
                      class="btn btn-sm btn-danger"
                      onclick="return confirm('Ban this user?');">
                Ban
              </button>
            <?php endif; ?>
          </form>
        </td>
      </tr>
    <?php endforeach; ?>
    </tbody>
  </table>
</div>

<?php include_once 'footer.php'; ?>
